(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Wolfram 14.1' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       154,          7]
NotebookDataLength[     13987,        352]
NotebookOptionsPosition[     13413,        335]
NotebookOutlinePosition[     13837,        352]
CellTagsIndexPosition[     13794,        349]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"SetDirectory", "[", 
   RowBox[{"NotebookDirectory", "[", "]"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"video", " ", "=", " ", 
    RowBox[{"Import", "[", "\"\<video.mp4\>\"", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"frames", " ", "=", " ", 
   RowBox[{"VideoFrameList", "[", 
    RowBox[{"video", ",", "All"}], "]"}]}], 
  ";"}], "\[IndentingNewLine]"}], "Input",
 CellChangeTimes->{{3.9474829007584724`*^9, 3.9474829374853516`*^9}, {
   3.9474829942793083`*^9, 3.947482994717947*^9}, {3.9474830366222897`*^9, 
   3.947483100554144*^9}, {3.94748324769145*^9, 3.9474832786354713`*^9}, {
   3.94748331636479*^9, 3.9474833185798798`*^9}, {3.947483365197235*^9, 
   3.947483368444647*^9}, {3.947483412221508*^9, 3.9474834148072433`*^9}, {
   3.9474834828230953`*^9, 3.947483494480192*^9}, {3.947483784940386*^9, 
   3.947483889582962*^9}, {3.9474839269351807`*^9, 3.9474839274403*^9}, {
   3.947484470331373*^9, 3.9474844760097847`*^9}, {3.9474845151793556`*^9, 
   3.9474845159952774`*^9}, {3.9474846427821236`*^9, 
   3.9474846840701237`*^9}, {3.9474849225248985`*^9, 
   3.9474849565162296`*^9}, {3.947485031236437*^9, 3.947485054837078*^9}, {
   3.94748514403928*^9, 3.94748514679241*^9}, {3.9474851874863663`*^9, 
   3.9474851882600327`*^9}, {3.9474852337532616`*^9, 
   3.9474853245231266`*^9}, {3.947485366547537*^9, 3.9474853674533234`*^9}, {
   3.9474854510061245`*^9, 3.9474854782877846`*^9}, {3.947485704305374*^9, 
   3.947485758357481*^9}, {3.947485813852518*^9, 3.947485855564583*^9}, 
   3.947488349725328*^9, {3.947488408018277*^9, 3.9474884108525057`*^9}, {
   3.947488442882427*^9, 3.9474884685842733`*^9}, {3.9474885332673483`*^9, 
   3.947488536243874*^9}},ExpressionUUID->"f02b3239-79fc-284a-ba30-\
46f11782062a"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"processaFrame", "[", "frame_Image", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "gray", ",", "filtered", ",", "components", ",", "edges", ",", "props", 
       ",", "squares"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
      "Assicurati", " ", "che", " ", "il", " ", "frame", " ", "sia", " ", 
       "effettivamente", " ", 
       RowBox[{"un", "'"}], "immagine"}], "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"!", 
         RowBox[{"ImageQ", "[", "frame", "]"}]}], ",", 
        RowBox[{"frame", "=", 
         RowBox[{"Image", "[", "frame", "]"}]}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Passo", " ", "2"}], ":", "Preprocessing"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"gray", "=", 
       RowBox[{"ColorConvert", "[", 
        RowBox[{"frame", ",", "\"\<Grayscale\>\""}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"filtered", "=", 
       RowBox[{"GaussianFilter", "[", 
        RowBox[{"gray", ",", "2"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Passo", " ", "3"}], ":", 
        RowBox[{"Estrazione", " ", "dei", " ", "bordi"}]}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"edges", "=", 
       RowBox[{"EdgeDetect", "[", "filtered", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"components", "=", 
       RowBox[{"MorphologicalComponents", "[", "edges", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"props", "=", 
       RowBox[{"ComponentMeasurements", "[", 
        RowBox[{"components", ",", 
         RowBox[{"{", 
          RowBox[{"\"\<BoundingBox\>\"", ",", "\"\<Elongation\>\""}], "}"}]}],
         "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Print", "[", "props", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"squares", "=", 
       RowBox[{"Select", "[", 
        RowBox[{"props", ",", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "1"}], "]"}], "]"}], ">", "1"}], "&&", 
           RowBox[{
            RowBox[{"#", "[", 
             RowBox[{"[", 
              RowBox[{"2", ",", "2"}], "]"}], "]"}], ">", "1"}], "&&", 
           RowBox[{
            RowBox[{"Abs", "[", 
             RowBox[{"1", "-", 
              RowBox[{
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "1"}], "]"}], "]"}], "/", 
               RowBox[{"#", "[", 
                RowBox[{"[", 
                 RowBox[{"2", ",", "2"}], "]"}], "]"}]}]}], "]"}], "<", 
            "0.3"}]}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"HighlightImage", "[", 
       RowBox[{"frame", ",", 
        RowBox[{"Rectangle", "@@@", 
         RowBox[{"squares", "[", 
          RowBox[{"[", 
           RowBox[{"All", ",", "2"}], "]"}], "]"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"Restituisci", " ", "il", " ", "risultato"}], ",", 
      RowBox[{
      "qui", " ", "ad", " ", "esempio", " ", "i", " ", "bordi", " ", 
       "rilevati"}]}], "*)"}], "\[IndentingNewLine]", "]"}]}], 
  "\n"}]], "Input",
 CellChangeTimes->{{3.9474856719382095`*^9, 3.947485688881281*^9}, 
   3.9474859124056225`*^9, {3.947485991033537*^9, 3.947486089737812*^9}, {
   3.9474861547386913`*^9, 3.947486164850111*^9}, {3.94748624741984*^9, 
   3.9474862715571995`*^9}, {3.947486347302309*^9, 3.947486349862444*^9}, {
   3.9474864327845135`*^9, 3.9474864337845287`*^9}, {3.947486934801529*^9, 
   3.9474869416663017`*^9}, {3.9474870214445553`*^9, 3.947487032227434*^9}, {
   3.9474871068999577`*^9, 3.9474871130770664`*^9}, {3.9474872030176697`*^9, 
   3.9474872141347446`*^9}, {3.947487249034916*^9, 3.9474872969050903`*^9}, {
   3.947487336721567*^9, 3.947487341425194*^9}, {3.9474875535759945`*^9, 
   3.947487573062483*^9}, 3.947487615167881*^9, {3.947487663983921*^9, 
   3.9474876897363815`*^9}, 3.9474877789800777`*^9, {3.9474883434963923`*^9, 
   3.947488345742393*^9}},
 CellLabel->"In[34]:=",ExpressionUUID->"7d0cf948-209a-3445-a8c5-f205d33175f4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "qua", " ", "sotto", " ", "il", " ", "codice", " ", "da", " ", 
       "applicare", " ", "completo", " ", "di", " ", "Debug", " ", "per", " ",
        "la", " ", "singola", " ", 
       RowBox[{"immagine", "/", "singolo"}], " ", "frame", " ", "in", " ", 
       "questo", " ", "caso", " ", "il", " ", "primo", " ", "ma", " ", "mi", 
       " ", "da", " ", "problemi", " ", "a", " ", "runnare", " ", "il", " ", 
       "video", " ", "e", " ", "caricarlo", " ", "quindi", " ", "non", " ", 
       "so", " ", "se", " ", "funziona", " ", "o", " ", "no"}], "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"video", "=", 
        RowBox[{"Import", "[", "\"\<percorso/del/video.mp4\>\"", "]"}]}], 
       ";"}], "\n", 
      RowBox[{
       RowBox[{"frame", "=", 
        RowBox[{"First", "[", 
         RowBox[{"Import", "[", 
          RowBox[{"\"\<percorso/del/video.mp4\>\"", ",", "\"\<Frames\>\""}], 
          "]"}], "]"}]}], ";"}], "\n", 
      RowBox[{
       RowBox[{"grayFrame", "=", 
        RowBox[{"ColorConvert", "[", 
         RowBox[{"frame", ",", "\"\<Grayscale\>\""}], "]"}]}], ";"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Miglioriamo", " ", 
        RowBox[{"l", "'"}], "immagine"}], "*)"}], "\n", 
      RowBox[{
       RowBox[{"enhanced", "=", 
        RowBox[{"ImageAdjust", "[", "grayFrame", "]"}]}], ";"}], "\n", 
      RowBox[{
       RowBox[{"binary", "=", 
        RowBox[{"Binarize", "[", 
         RowBox[{"enhanced", ",", "0.5"}], "]"}]}], ";"}], "\n", 
      RowBox[{
       RowBox[{"edges", "=", 
        RowBox[{"EdgeDetect", "[", 
         RowBox[{"binary", ",", "2"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Troviamo", " ", "componenti"}], "*)"}], "\n", 
      RowBox[{
       RowBox[{"components", "=", 
        RowBox[{"MorphologicalComponents", "[", "edges", "]"}]}], ";"}], "\n", 
      RowBox[{
       RowBox[{"props", "=", 
        RowBox[{"ComponentMeasurements", "[", 
         RowBox[{"components", ",", 
          RowBox[{"{", 
           RowBox[{"\"\<BoundingBox\>\"", ",", "\"\<Elongation\>\""}], 
           "}"}]}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"\"\<Bounding box trovate: \>\"", ",", "props"}], "]"}], 
       ";"}], " ", 
      RowBox[{"(*", 
       RowBox[{"Controlliamo", " ", "cosa", " ", 
        RowBox[{"c", "'"}], "\[EGrave]", " ", "in", " ", "props"}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "Proviamo", " ", "un", " ", "filtro", " ", "meno", " ", 
        "restrittivo"}], "*)"}], "\n", 
      RowBox[{
       RowBox[{"squares", "=", 
        RowBox[{"Select", "[", 
         RowBox[{"props", ",", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "1"}], "]"}], "]"}], ">", "1"}], "&&", 
            RowBox[{
             RowBox[{"#", "[", 
              RowBox[{"[", 
               RowBox[{"2", ",", "2"}], "]"}], "]"}], ">", "1"}], "&&", 
            RowBox[{
             RowBox[{"Abs", "[", 
              RowBox[{"1", "-", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "1"}], "]"}], "]"}], "/", 
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "2"}], "]"}], "]"}]}]}], "]"}], "<", 
             "0.3"}]}], "&"}]}], "]"}]}], ";"}], "\n", "\[IndentingNewLine]", 
      
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"\"\<Quadrati rilevati: \>\"", ",", "squares"}], "]"}], ";"}],
       " ", 
      RowBox[{"(*", 
       RowBox[{
       "Verifica", " ", "quanti", " ", "quadrati", " ", "ci", " ", "sono"}], 
       "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Se", " ", "squares", " ", "\[EGrave]", " ", "vuoto"}], ",", 
        RowBox[{
        "proviamo", " ", "senza", " ", "filtro", " ", "sulla", " ", 
         "forma"}]}], "*)"}], "\n", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "[", "squares", "]"}], "==", "0"}], ",", 
         RowBox[{
          RowBox[{"squares", "=", 
           RowBox[{"Select", "[", 
            RowBox[{"props", ",", 
             RowBox[{
              RowBox[{
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "1"}], "]"}], "]"}], ">", "1"}], "&&", 
               RowBox[{
                RowBox[{"#", "[", 
                 RowBox[{"[", 
                  RowBox[{"2", ",", "2"}], "]"}], "]"}], ">", "1"}]}], 
              "&"}]}], "]"}]}], ";"}]}], "]"}], ";"}], "\n", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"\"\<Quadrati dopo correzione: \>\"", ",", "squares"}], "]"}],
        ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Convertiamo", " ", "in", " ", "rettangoli"}], "*)"}], "\n", 
      RowBox[{"rectangles", "=", 
       RowBox[{"Rectangle", "@@@", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"squares", "[", 
           RowBox[{"[", 
            RowBox[{"All", ",", "2"}], "]"}], "]"}], "/.", " ", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x_", ",", "y_"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{"w_", ",", "h_"}], "}"}]}], "}"}], ":>", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"x", ",", "y"}], "}"}], ",", 
             RowBox[{"{", 
              RowBox[{
               RowBox[{"x", "+", "w"}], ",", 
               RowBox[{"y", "+", "h"}]}], "}"}]}], "}"}]}]}]}]}]}]}], "}"}], 
    ")"}], ";"}], "\[IndentingNewLine]", "\n", 
  RowBox[{"(*", 
   RowBox[{"Disegniamo", " ", "i", " ", "bounding", " ", "box"}], 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{"ImageCompose", "[", 
  RowBox[{"frame", ",", 
   RowBox[{"Graphics", "[", 
    RowBox[{"{", 
     RowBox[{"Red", ",", 
      RowBox[{"Thickness", "[", "0.005", "]"}], ",", "rectangles"}], "}"}], 
    "]"}]}], "]"}], "\n"}], "Input",
 CellChangeTimes->{{3.947488565689781*^9, 
  3.947488617463368*^9}},ExpressionUUID->"b1e1a481-f2c9-4a52-91a6-\
194634d55015"]
},
WindowSize->{Full, Full},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
Magnification:>1.35 Inherited,
FrontEndVersion->"14.1 for Mac OS X ARM (64-bit) (July 16, 2024)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"83cecfb7-9517-7646-b2eb-1a63f13cd3f6"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[554, 20, 1850, 34, 149, "Input",ExpressionUUID->"f02b3239-79fc-284a-ba30-46f11782062a"],
Cell[2407, 56, 4326, 102, 453, "Input",ExpressionUUID->"7d0cf948-209a-3445-a8c5-f205d33175f4"],
Cell[6736, 160, 6673, 173, 949, "Input",ExpressionUUID->"b1e1a481-f2c9-4a52-91a6-194634d55015"]
}
]
*)

